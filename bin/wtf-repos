#!/bin/bash
# Find all git repos in ~/dev and show their current state

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
GREY='\033[0;90m'
NC='\033[0m' # No Color

find ~/dev -maxdepth 3 -name ".git" -type d 2>/dev/null | while read gitdir; do
  repo=$(dirname "$gitdir")
  name=$(basename "$repo")

  cd "$repo" || continue

  branch=$(git branch --show-current 2>/dev/null)
  status=$(git status --porcelain 2>/dev/null | wc -l | tr -d ' ')

  if [ "$status" -gt 0 ]; then
    state="${RED}●${NC}"
  else
    state="${GREEN}●${NC}"
  fi

  # Check ahead/behind
  ahead=$(git rev-list --count @{upstream}..HEAD 2>/dev/null || echo "0")
  behind=$(git rev-list --count HEAD..@{upstream} 2>/dev/null || echo "0")

  sync=""
  [ "$ahead" -gt 0 ] && sync="${YELLOW}↑${ahead}${NC}"
  [ "$behind" -gt 0 ] && sync="${sync}${YELLOW}↓${behind}${NC}"

  printf "%b %-25s ${GREY}%-15s${NC} %b\n" "$state" "$name" "$branch" "$sync"
done | sort
