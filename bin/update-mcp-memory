#!/bin/bash
# Update mcp-memory-service and hooks

set -e

NODE_PATH="/Users/channing/.nvm/versions/node/v25.2.0/bin/node"
NEEDS_UPDATE=false
FORCE=${1:-}

echo "=== Checking mcp-memory-service ==="
uv_output=$(uv tool upgrade mcp-memory-service 2>&1)
echo "$uv_output"
if [[ ! "$uv_output" =~ "already at latest" ]] && [[ ! "$uv_output" =~ "Nothing to upgrade" ]]; then
    NEEDS_UPDATE=true
    echo "→ Package updated"
fi

echo ""
echo "=== Checking hooks repo ==="
cd ~/dev/mcp-memory-service
# Fetch upstream and update main branch (hooks come from upstream)
git fetch upstream 2>&1
current_main=$(git rev-parse main)
upstream_main=$(git rev-parse upstream/main)
if [[ "$current_main" != "$upstream_main" ]]; then
    echo "Updating main: $(git log --oneline main..upstream/main | wc -l | tr -d ' ') commits behind"
    git checkout main 2>&1
    git merge upstream/main --ff-only 2>&1
    git checkout - 2>&1
    NEEDS_UPDATE=true
    echo "→ Repo updated"
else
    echo "Already up to date."
fi

if [[ "$FORCE" == "--force" ]] || [[ "$FORCE" == "-f" ]]; then
    NEEDS_UPDATE=true
    echo "→ Force flag set"
fi

if [[ "$NEEDS_UPDATE" == "false" ]]; then
    echo ""
    echo "✓ Everything up to date, skipping reinstall"
    exit 0
fi

echo ""
echo "=== Installing hooks ==="
# Run installer from main branch (where releases come from)
git stash -q 2>/dev/null || true
git checkout main -q
python3 claude-hooks/install_hooks.py --natural-triggers
git checkout - -q
git stash pop -q 2>/dev/null || true

echo ""
echo "=== Recreating session-start wrapper ==="
cat > ~/.claude/hooks/session-start-wrapper.sh << 'WRAPPER'
#!/bin/bash
# Wrapper for session-start hook that outputs proper JSON for Claude Code

NODE_PATH="/Users/channing/.nvm/versions/node/v25.2.0/bin/node"
HOOK_PATH="/Users/channing/.claude/hooks/core/session-start.js"

# Capture the hook output, strip ANSI codes
output=$("$NODE_PATH" "$HOOK_PATH" 2>&1 | sed 's/\x1b\[[0-9;]*m//g')

# Output as JSON that Claude Code expects
cat << EOF
{
  "hookSpecificOutput": {
    "hookEventName": "SessionStart",
    "additionalContext": $(echo "$output" | jq -Rs .)
  }
}
EOF

exit 0
WRAPPER
chmod +x ~/.claude/hooks/session-start-wrapper.sh

echo ""
echo "=== Fixing settings.json hooks format ==="
# Use jq to update the hooks section with correct format and full node path
jq '.hooks = {
  "SessionStart": [{
    "matcher": "",
    "hooks": [{
      "type": "command",
      "command": "/Users/channing/.claude/hooks/session-start-wrapper.sh"
    }]
  }],
  "SessionEnd": [{
    "matcher": "",
    "hooks": [{
      "type": "command",
      "command": "/Users/channing/.nvm/versions/node/v25.2.0/bin/node /Users/channing/.claude/hooks/core/session-end.js"
    }]
  }],
  "UserPromptSubmit": [{
    "matcher": "",
    "hooks": [{
      "type": "command",
      "command": "/Users/channing/.nvm/versions/node/v25.2.0/bin/node /Users/channing/.claude/hooks/core/mid-conversation.js"
    }]
  }]
}' ~/.claude/settings.json > ~/.claude/settings.json.tmp && mv ~/.claude/settings.json.tmp ~/.claude/settings.json

echo ""
echo "=== Restarting HTTP server ==="
launchctl unload ~/Library/LaunchAgents/com.mcp-memory.http-server.plist 2>/dev/null || true
launchctl load ~/Library/LaunchAgents/com.mcp-memory.http-server.plist

echo ""
echo "=== Verifying ==="
sleep 2
curl -s http://127.0.0.1:8000/api/health | jq -r '"HTTP Server: " + .version'
echo "Done!"
